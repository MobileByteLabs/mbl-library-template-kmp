# Template Customization Workflow
# Helps users customize the template after creating a new repository from it

name: Template Customization

on:
  # Trigger manually with customization parameters
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Package name (e.g., com.example.mylibrary)'
        required: true
        type: string
      library_name:
        description: 'Library name (e.g., MyAwesomeLib)'
        required: true
        type: string
      organization:
        description: 'GitHub organization/username (leave empty to use repo owner)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

jobs:
  customize:
    name: Customize Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Inputs
        id: validate
        run: |
          # Validate package name format
          if [[ ! "${{ inputs.package_name }}" =~ ^[a-z][a-z0-9]*(\.[a-z][a-z0-9]*)+$ ]]; then
            echo "Error: Invalid package name format. Use lowercase letters, numbers, and dots (e.g., com.example.mylibrary)"
            exit 1
          fi

          # Validate library name (alphanumeric, can include hyphens)
          if [[ ! "${{ inputs.library_name }}" =~ ^[A-Za-z][A-Za-z0-9-]*$ ]]; then
            echo "Error: Invalid library name. Use letters, numbers, and hyphens (e.g., MyAwesomeLib)"
            exit 1
          fi

          # Use provided organization or default to repository owner
          ORG="${{ inputs.organization }}"
          if [ -z "$ORG" ]; then
            ORG="${{ github.repository_owner }}"
            echo "Using repository owner as organization: $ORG"
          fi
          echo "organization=$ORG" >> $GITHUB_OUTPUT

          echo "Inputs validated successfully!"
          echo "Package: ${{ inputs.package_name }}"
          echo "Library: ${{ inputs.library_name }}"
          echo "Organization: $ORG"

      - name: Setup Bash 4+
        run: |
          # Ubuntu has bash 5+ by default
          bash --version

      - name: Run Customizer
        run: |
          chmod +x customizer.sh
          bash customizer.sh "${{ inputs.package_name }}" "${{ inputs.library_name }}" "${{ steps.validate.outputs.organization }}"

      - name: Remove Template Files
        run: |
          # Remove the customizer script after use
          rm -f customizer.sh

          # Remove this workflow after customization
          rm -f .github/workflows/template-customize.yml

          # Remove template-specific files if they exist
          rm -f TEMPLATE.md

      - name: Commit Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "chore: Customize template for ${{ inputs.library_name }}

          - Package: ${{ inputs.package_name }}
          - Library: ${{ inputs.library_name }}
          - Organization: ${{ steps.validate.outputs.organization }}

          Generated by Template Customization workflow"
          git push
